name: Publish Package

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

# 顶层 permissions 必须有 id-token: write
permissions:
  id-token: write
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 手动请求 OIDC token，绕过 actions/id-token 内置 Action
      - name: Request OIDC token manually
        id: oidc
        run: |
          echo "Requesting OIDC token..."
          TOKEN=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL?audience=https://registry.npmjs.org/")
          echo "OIDC token: $TOKEN"
          # 输出 token 供后续 steps 使用
          echo "oidc_token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Use OIDC token for npm publish
        run: |
          echo "Publishing package with OIDC token..."
          # 这里示例用 curl 调用 npm publish API
          curl -v -X PUT "https://registry.npmjs.org/YOUR_PACKAGE_NAME" \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.oidc_token }}" \
            -d @package.tgz
